name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Get Version
      id: get_version
      run: |
        VERSION="${{ github.ref_name }}"
        # Strip 'v' prefix if present
        VERSION="${VERSION#v}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ruby ruby-dev rubygems build-essential
        sudo gem install --no-document fpm
        pip install PyQt6 pyxdg pyinstaller

    - name: Build Standalone Executable (PyInstaller)
      run: |
        pyinstaller --name wlaunch_bin --onefile --windowed --add-data "styles.qss:." wlaunch.py
        mkdir -p dist
        mv dist/wlaunch_bin dist/wlaunch-linux-x86_64

    - name: Prepare Build Structure
      run: |
        mkdir -p dist_root/usr/bin
        mkdir -p dist_root/usr/lib/systemd/user
        mkdir -p dist_root/usr/share/applications

        # Copy Binary (Bundled with libs)
        cp dist/wlaunch-linux-x86_64 dist_root/usr/bin/wlaunch
        chmod +x dist_root/usr/bin/wlaunch

        # We also need the daemon binary. 
        # For simplicity in this bundled approach, we will use the SAME binary 
        # but trigger daemon mode via a flag or separate entry point if possible.
        # Since we didn't add cli flags to wlaunch.py, let's build the daemon separately or 
        # accept that the main binary includes the daemon logic if we merge them.
        # For now, let's build the daemon as a separate binary to be safe.
        
        pyinstaller --name wlaunch_daemon_bin --onefile --windowed core/clipboard_daemon.py
        cp dist/wlaunch_daemon_bin dist_root/usr/bin/wlaunch-daemon
        chmod +x dist_root/usr/bin/wlaunch-daemon

        # Create Systemd Service
        cat <<EOT > dist_root/usr/lib/systemd/user/wlaunch-daemon.service
        [Unit]
        Description=wlaunch Clipboard Daemon
        After=graphical-session.target

        [Service]
        ExecStart=/usr/bin/wlaunch-daemon
        Restart=on-failure

        [Install]
        WantedBy=default.target
        EOT

        # Create Desktop Entry
        cat <<EOT > dist_root/usr/share/applications/wlaunch.desktop
        [Desktop Entry]
        Name=wlaunch
        Comment=Raycast-like launcher
        Exec=wlaunch
        Icon=system-search
        Terminal=false
        Type=Application
        Categories=Utility;
        EOT

    - name: Build DEB Package
      run: |
        fpm -s dir -t deb \
          -n wlaunch \
          -v ${{ env.VERSION }} \
          -a all \
          -m "kpanuragh <git@github.com>" \
          --description "A Raycast-like launcher for i3" \
          -p dist/wlaunch_${{ env.VERSION }}_amd64.deb \
          -C dist_root .

    - name: Build RPM Package
      run: |
        fpm -s dir -t rpm \
          -n wlaunch \
          -v ${{ env.VERSION }} \
          -a all \
          -m "kpanuragh <git@github.com>" \
          --description "A Raycast-like launcher for i3" \
          -p dist/wlaunch-${{ env.VERSION }}-1.x86_64.rpm \
          -C dist_root .

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          dist/*.deb
          dist/*.rpm
          dist/wlaunch-linux-x86_64
        draft: false
        prerelease: false
        generate_release_notes: true
